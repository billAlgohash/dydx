"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.SignableOraclePrice = void 0;
const big_js_1 = __importDefault(require("big.js"));
const helpers_1 = require("../helpers");
const crypto_1 = require("../lib/crypto");
const util_1 = require("../lib/util");
const constants_1 = require("./constants");
const stark_signable_1 = require("./stark-signable");
/**
 * Wrapper object to hash, sign, and verify an oracle price.
 */
class SignableOraclePrice extends stark_signable_1.StarkSignable {
    static fromPriceWithMarket(params, networkId) {
        if (typeof params.market !== 'string') {
            throw new Error('SignableOraclePrice.fromPrice: market must be a string');
        }
        const assetName = (0, helpers_1.getSignedAssetName)(params.market);
        return SignableOraclePrice.fromPriceWithAssetName({
            ...params,
            assetName,
        }, networkId);
    }
    static fromPriceWithAssetName(params, networkId) {
        if (typeof params.assetName !== 'string') {
            throw new Error('SignableOraclePrice.fromPrice: assetName must be a string');
        }
        if (typeof params.oracleName !== 'string') {
            throw new Error('SignableOraclePrice.fromPrice: oracleName must be a string');
        }
        if (typeof params.humanPrice !== 'string') {
            throw new Error('SignableOraclePrice.fromPrice: humanPrice must be a string');
        }
        if (typeof params.isoTimestamp !== 'string') {
            throw new Error('SignableOraclePrice.fromPrice: isoTimestamp must be a string');
        }
        const signedAssetId = (0, helpers_1.getSignedAssetId)(params.assetName, params.oracleName);
        const signedPrice = new big_js_1.default(params.humanPrice);
        signedPrice.e += constants_1.ORACLE_PRICE_DECIMALS;
        if (!signedPrice.mod(1).eq(0)) {
            throw new Error('SignableOraclePrice.fromPrice: humanPrice can have at most 18 decimals of precision');
        }
        const expirationEpochSeconds = (0, helpers_1.isoTimestampToEpochSeconds)(params.isoTimestamp);
        return new SignableOraclePrice({
            signedAssetId,
            signedPrice: signedPrice.toFixed(0),
            expirationEpochSeconds,
        }, networkId);
    }
    async calculateHash() {
        const priceBn = (0, util_1.decToBn)(this.message.signedPrice);
        const timestampEpochSecondsBn = (0, util_1.intToBn)(this.message.expirationEpochSeconds);
        const signedAssetId = (0, util_1.hexToBn)(this.message.signedAssetId);
        if (priceBn.bitLength() > constants_1.ORACLE_PRICE_FIELD_BIT_LENGTHS.price) {
            throw new Error('SignableOraclePrice: price exceeds max value');
        }
        if (timestampEpochSecondsBn.bitLength() > constants_1.ORACLE_PRICE_FIELD_BIT_LENGTHS.timestampEpochSeconds) {
            throw new Error('SignableOraclePrice: timestampEpochSeconds exceeds max value');
        }
        const priceAndTimestamp = priceBn
            .iushln(constants_1.ORACLE_PRICE_FIELD_BIT_LENGTHS.timestampEpochSeconds)
            .iadd(timestampEpochSecondsBn);
        return (0, crypto_1.getPedersenHash)(signedAssetId, priceAndTimestamp);
    }
}
exports.SignableOraclePrice = SignableOraclePrice;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib3JhY2xlLXByaWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL3NpZ25hYmxlL29yYWNsZS1wcmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7QUFBQSxvREFBeUI7QUFHekIsd0NBSW9CO0FBQ3BCLDBDQUFnRDtBQUNoRCxzQ0FJcUI7QUFPckIsMkNBR3FCO0FBQ3JCLHFEQUFpRDtBQUVqRDs7R0FFRztBQUNILE1BQWEsbUJBQW9CLFNBQVEsOEJBQW1DO0lBRTFFLE1BQU0sQ0FBQyxtQkFBbUIsQ0FDeEIsTUFBNkIsRUFDN0IsU0FBb0I7UUFFcEIsSUFBSSxPQUFPLE1BQU0sQ0FBQyxNQUFNLEtBQUssUUFBUSxFQUFFO1lBQ3JDLE1BQU0sSUFBSSxLQUFLLENBQUMsd0RBQXdELENBQUMsQ0FBQztTQUMzRTtRQUNELE1BQU0sU0FBUyxHQUFHLElBQUEsNEJBQWtCLEVBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQ3BELE9BQU8sbUJBQW1CLENBQUMsc0JBQXNCLENBQy9DO1lBQ0UsR0FBRyxNQUFNO1lBQ1QsU0FBUztTQUNWLEVBQ0QsU0FBUyxDQUNWLENBQUM7SUFDSixDQUFDO0lBRUQsTUFBTSxDQUFDLHNCQUFzQixDQUMzQixNQUFnQyxFQUNoQyxTQUFvQjtRQUVwQixJQUFJLE9BQU8sTUFBTSxDQUFDLFNBQVMsS0FBSyxRQUFRLEVBQUU7WUFDeEMsTUFBTSxJQUFJLEtBQUssQ0FBQywyREFBMkQsQ0FBQyxDQUFDO1NBQzlFO1FBQ0QsSUFBSSxPQUFPLE1BQU0sQ0FBQyxVQUFVLEtBQUssUUFBUSxFQUFFO1lBQ3pDLE1BQU0sSUFBSSxLQUFLLENBQUMsNERBQTRELENBQUMsQ0FBQztTQUMvRTtRQUNELElBQUksT0FBTyxNQUFNLENBQUMsVUFBVSxLQUFLLFFBQVEsRUFBRTtZQUN6QyxNQUFNLElBQUksS0FBSyxDQUFDLDREQUE0RCxDQUFDLENBQUM7U0FDL0U7UUFDRCxJQUFJLE9BQU8sTUFBTSxDQUFDLFlBQVksS0FBSyxRQUFRLEVBQUU7WUFDM0MsTUFBTSxJQUFJLEtBQUssQ0FBQyw4REFBOEQsQ0FBQyxDQUFDO1NBQ2pGO1FBRUQsTUFBTSxhQUFhLEdBQUcsSUFBQSwwQkFBZ0IsRUFBQyxNQUFNLENBQUMsU0FBUyxFQUFFLE1BQU0sQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUU1RSxNQUFNLFdBQVcsR0FBRyxJQUFJLGdCQUFHLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBQy9DLFdBQVcsQ0FBQyxDQUFDLElBQUksaUNBQXFCLENBQUM7UUFFdkMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxFQUFFO1lBQzdCLE1BQU0sSUFBSSxLQUFLLENBQ2IscUZBQXFGLENBQ3RGLENBQUM7U0FDSDtRQUVELE1BQU0sc0JBQXNCLEdBQUcsSUFBQSxvQ0FBMEIsRUFBQyxNQUFNLENBQUMsWUFBWSxDQUFDLENBQUM7UUFFL0UsT0FBTyxJQUFJLG1CQUFtQixDQUM1QjtZQUNFLGFBQWE7WUFDYixXQUFXLEVBQUUsV0FBVyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUM7WUFDbkMsc0JBQXNCO1NBQ3ZCLEVBQ0QsU0FBUyxDQUNWLENBQUM7SUFDSixDQUFDO0lBRVMsS0FBSyxDQUFDLGFBQWE7UUFDM0IsTUFBTSxPQUFPLEdBQUcsSUFBQSxjQUFPLEVBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUNsRCxNQUFNLHVCQUF1QixHQUFHLElBQUEsY0FBTyxFQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsc0JBQXNCLENBQUMsQ0FBQztRQUM3RSxNQUFNLGFBQWEsR0FBRyxJQUFBLGNBQU8sRUFBQyxJQUFJLENBQUMsT0FBTyxDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBRTFELElBQUksT0FBTyxDQUFDLFNBQVMsRUFBRSxHQUFHLDBDQUE4QixDQUFDLEtBQUssRUFBRTtZQUM5RCxNQUFNLElBQUksS0FBSyxDQUFDLDhDQUE4QyxDQUFDLENBQUM7U0FDakU7UUFDRCxJQUNFLHVCQUF1QixDQUFDLFNBQVMsRUFBRSxHQUFHLDBDQUE4QixDQUFDLHFCQUFxQixFQUMxRjtZQUNBLE1BQU0sSUFBSSxLQUFLLENBQUMsOERBQThELENBQUMsQ0FBQztTQUNqRjtRQUVELE1BQU0saUJBQWlCLEdBQUcsT0FBTzthQUM5QixNQUFNLENBQUMsMENBQThCLENBQUMscUJBQXFCLENBQUM7YUFDNUQsSUFBSSxDQUFDLHVCQUF1QixDQUFDLENBQUM7UUFFakMsT0FBTyxJQUFBLHdCQUFlLEVBQUMsYUFBYSxFQUFFLGlCQUFpQixDQUFDLENBQUM7SUFDM0QsQ0FBQztDQUNGO0FBL0VELGtEQStFQyJ9