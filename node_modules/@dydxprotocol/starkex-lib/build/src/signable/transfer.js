"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.SignableTransfer = void 0;
const bn_js_1 = __importDefault(require("bn.js"));
const constants_1 = require("../constants");
const helpers_1 = require("../helpers");
const crypto_1 = require("../lib/crypto");
const util_1 = require("../lib/util");
const constants_2 = require("./constants");
const hashes_1 = require("./hashes");
const stark_signable_1 = require("./stark-signable");
// Note: Fees are not supported for transfers.
const MAX_AMOUNT_FEE_BN = new bn_js_1.default(0);
const TRANSFER_PREFIX = 4;
const TRANSFER_PADDING_BITS = 81;
/**
 * Wrapper object to convert a transfer, and hash, sign, and verify its signature.
 */
class SignableTransfer extends stark_signable_1.StarkSignable {
    static fromTransfer(transfer, networkId) {
        const nonce = (0, helpers_1.nonceFromClientId)(transfer.clientId);
        // The transfer asset is always the collateral asset.
        const quantumsAmount = (0, helpers_1.toQuantumsExact)(transfer.humanAmount, constants_1.COLLATERAL_ASSET);
        // Convert to a Unix timestamp (in hours).
        const expirationEpochHours = (0, helpers_1.isoTimestampToEpochHours)(transfer.expirationIsoTimestamp);
        return new SignableTransfer({
            senderPositionId: transfer.senderPositionId,
            receiverPositionId: transfer.receiverPositionId,
            receiverPublicKey: transfer.receiverPublicKey,
            quantumsAmount,
            nonce,
            expirationEpochHours,
        }, networkId);
    }
    async calculateHash() {
        const senderPositionIdBn = (0, util_1.decToBn)(this.message.senderPositionId);
        const receiverPositionIdBn = (0, util_1.decToBn)(this.message.receiverPositionId);
        const receiverPublicKeyBn = (0, util_1.hexToBn)(this.message.receiverPublicKey);
        const quantumsAmountBn = (0, util_1.decToBn)(this.message.quantumsAmount);
        const nonceBn = (0, util_1.decToBn)(this.message.nonce);
        const expirationEpochHoursBn = (0, util_1.intToBn)(this.message.expirationEpochHours);
        if (senderPositionIdBn.bitLength() > constants_2.TRANSFER_FIELD_BIT_LENGTHS.positionId) {
            throw new Error('SignableOraclePrice: senderPositionId exceeds max value');
        }
        if (receiverPositionIdBn.bitLength() > constants_2.TRANSFER_FIELD_BIT_LENGTHS.positionId) {
            throw new Error('SignableOraclePrice: receiverPositionId exceeds max value');
        }
        if (receiverPublicKeyBn.bitLength() > constants_2.TRANSFER_FIELD_BIT_LENGTHS.receiverPublicKey) {
            throw new Error('SignableOraclePrice: receiverPublicKey exceeds max value');
        }
        if (quantumsAmountBn.bitLength() > constants_2.TRANSFER_FIELD_BIT_LENGTHS.quantumsAmount) {
            throw new Error('SignableOraclePrice: quantumsAmount exceeds max value');
        }
        if (nonceBn.bitLength() > constants_2.TRANSFER_FIELD_BIT_LENGTHS.nonce) {
            throw new Error('SignableOraclePrice: nonce exceeds max value');
        }
        if (expirationEpochHoursBn.bitLength() >
            constants_2.TRANSFER_FIELD_BIT_LENGTHS.expirationEpochHours) {
            throw new Error('SignableOraclePrice: expirationEpochHours exceeds max value');
        }
        // The transfer asset is always the collateral asset.
        // Fees are not supported for transfers.
        const assetIds = await (0, hashes_1.getCacheablePedersenHash)((0, util_1.hexToBn)(constants_1.COLLATERAL_ASSET_ID_BY_NETWORK_ID[this.networkId]), constants_2.TRANSFER_FEE_ASSET_ID_BN);
        const transferPart1 = await (0, crypto_1.getPedersenHash)(assetIds, receiverPublicKeyBn);
        // Note: Use toString() to avoid mutating senderPositionIdBn.
        const transferPart2 = new bn_js_1.default(senderPositionIdBn.toString(), 10)
            .iushln(constants_2.TRANSFER_FIELD_BIT_LENGTHS.positionId).iadd(receiverPositionIdBn)
            .iushln(constants_2.TRANSFER_FIELD_BIT_LENGTHS.positionId).iadd(senderPositionIdBn)
            .iushln(constants_2.TRANSFER_FIELD_BIT_LENGTHS.nonce).iadd(nonceBn);
        const transferPart3 = new bn_js_1.default(TRANSFER_PREFIX)
            .iushln(constants_2.TRANSFER_FIELD_BIT_LENGTHS.quantumsAmount).iadd(quantumsAmountBn)
            .iushln(constants_2.TRANSFER_FIELD_BIT_LENGTHS.quantumsAmount).iadd(MAX_AMOUNT_FEE_BN)
            .iushln(constants_2.TRANSFER_FIELD_BIT_LENGTHS.expirationEpochHours).iadd(expirationEpochHoursBn)
            .iushln(TRANSFER_PADDING_BITS);
        return (0, crypto_1.getPedersenHash)(await (0, crypto_1.getPedersenHash)(transferPart1, transferPart2), transferPart3);
    }
    toStarkware() {
        return this.message;
    }
}
exports.SignableTransfer = SignableTransfer;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHJhbnNmZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvc2lnbmFibGUvdHJhbnNmZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEsa0RBQXVCO0FBRXZCLDRDQUdzQjtBQUN0Qix3Q0FJb0I7QUFDcEIsMENBQWdEO0FBQ2hELHNDQUlxQjtBQU1yQiwyQ0FHcUI7QUFDckIscUNBQW9EO0FBQ3BELHFEQUFpRDtBQUVqRCw4Q0FBOEM7QUFDOUMsTUFBTSxpQkFBaUIsR0FBRyxJQUFJLGVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUVwQyxNQUFNLGVBQWUsR0FBRyxDQUFDLENBQUM7QUFDMUIsTUFBTSxxQkFBcUIsR0FBRyxFQUFFLENBQUM7QUFFakM7O0dBRUc7QUFDSCxNQUFhLGdCQUFpQixTQUFRLDhCQUFnQztJQUVwRSxNQUFNLENBQUMsWUFBWSxDQUNqQixRQUF3QixFQUN4QixTQUFvQjtRQUVwQixNQUFNLEtBQUssR0FBRyxJQUFBLDJCQUFpQixFQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUVuRCxxREFBcUQ7UUFDckQsTUFBTSxjQUFjLEdBQUcsSUFBQSx5QkFBZSxFQUFDLFFBQVEsQ0FBQyxXQUFXLEVBQUUsNEJBQWdCLENBQUMsQ0FBQztRQUUvRSwwQ0FBMEM7UUFDMUMsTUFBTSxvQkFBb0IsR0FBRyxJQUFBLGtDQUF3QixFQUFDLFFBQVEsQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDO1FBRXZGLE9BQU8sSUFBSSxnQkFBZ0IsQ0FDekI7WUFDRSxnQkFBZ0IsRUFBRSxRQUFRLENBQUMsZ0JBQWdCO1lBQzNDLGtCQUFrQixFQUFFLFFBQVEsQ0FBQyxrQkFBa0I7WUFDL0MsaUJBQWlCLEVBQUUsUUFBUSxDQUFDLGlCQUFpQjtZQUM3QyxjQUFjO1lBQ2QsS0FBSztZQUNMLG9CQUFvQjtTQUNyQixFQUNELFNBQVMsQ0FDVixDQUFDO0lBQ0osQ0FBQztJQUVTLEtBQUssQ0FBQyxhQUFhO1FB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