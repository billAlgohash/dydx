"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.SignableConditionalTransfer = void 0;
const bn_js_1 = __importDefault(require("bn.js"));
const constants_1 = require("../constants");
const helpers_1 = require("../helpers");
const crypto_1 = require("../lib/crypto");
const util_1 = require("../lib/util");
const constants_2 = require("./constants");
const hashes_1 = require("./hashes");
const stark_signable_1 = require("./stark-signable");
// Note: Fees are not supported for conditional transfers.
const MAX_AMOUNT_FEE_BN = new bn_js_1.default(0);
const CONDITIONAL_TRANSFER_PREFIX = 5;
const CONDITIONAL_TRANSFER_PADDING_BITS = 81;
/**
 * Wrapper object to convert a conditional transfer, and hash, sign, and verify its signature.
 */
class SignableConditionalTransfer extends stark_signable_1.StarkSignable {
    static fromTransfer(transfer, networkId) {
        const nonce = (0, helpers_1.nonceFromClientId)(transfer.clientId);
        // The transfer asset is always the collateral asset.
        const quantumsAmount = (0, helpers_1.toQuantumsExact)(transfer.humanAmount, constants_1.COLLATERAL_ASSET);
        // Convert to a Unix timestamp (in hours).
        const expirationEpochHours = (0, helpers_1.isoTimestampToEpochHours)(transfer.expirationIsoTimestamp);
        return new SignableConditionalTransfer({
            senderPositionId: transfer.senderPositionId,
            receiverPositionId: transfer.receiverPositionId,
            receiverPublicKey: transfer.receiverPublicKey,
            condition: (0, util_1.factToCondition)(transfer.factRegistryAddress, transfer.fact),
            quantumsAmount,
            nonce,
            expirationEpochHours,
        }, networkId);
    }
    async calculateHash() {
        const senderPositionIdBn = (0, util_1.decToBn)(this.message.senderPositionId);
        const receiverPositionIdBn = (0, util_1.decToBn)(this.message.receiverPositionId);
        const receiverPublicKeyBn = (0, util_1.hexToBn)(this.message.receiverPublicKey);
        const conditionBn = (0, util_1.hexToBn)(this.message.condition);
        const quantumsAmountBn = (0, util_1.decToBn)(this.message.quantumsAmount);
        const nonceBn = (0, util_1.decToBn)(this.message.nonce);
        const expirationEpochHoursBn = (0, util_1.intToBn)(this.message.expirationEpochHours);
        if (senderPositionIdBn.bitLength() > constants_2.CONDITIONAL_TRANSFER_FIELD_BIT_LENGTHS.positionId) {
            throw new Error('SignableOraclePrice: senderPositionId exceeds max value');
        }
        if (receiverPositionIdBn.bitLength() > constants_2.CONDITIONAL_TRANSFER_FIELD_BIT_LENGTHS.positionId) {
            throw new Error('SignableOraclePrice: receiverPositionId exceeds max value');
        }
        if (receiverPublicKeyBn.bitLength() > constants_2.CONDITIONAL_TRANSFER_FIELD_BIT_LENGTHS.receiverPublicKey) {
            throw new Error('SignableOraclePrice: receiverPublicKey exceeds max value');
        }
        if (conditionBn.bitLength() > constants_2.CONDITIONAL_TRANSFER_FIELD_BIT_LENGTHS.condition) {
            throw new Error('SignableOraclePrice: condition exceeds max value');
        }
        if (quantumsAmountBn.bitLength() > constants_2.CONDITIONAL_TRANSFER_FIELD_BIT_LENGTHS.quantumsAmount) {
            throw new Error('SignableOraclePrice: quantumsAmount exceeds max value');
        }
        if (nonceBn.bitLength() > constants_2.CONDITIONAL_TRANSFER_FIELD_BIT_LENGTHS.nonce) {
            throw new Error('SignableOraclePrice: nonce exceeds max value');
        }
        if (expirationEpochHoursBn.bitLength() >
            constants_2.CONDITIONAL_TRANSFER_FIELD_BIT_LENGTHS.expirationEpochHours) {
            throw new Error('SignableOraclePrice: expirationEpochHours exceeds max value');
        }
        // The transfer asset is always the collateral asset.
        // Fees are not supported for conditional transfers.
        const assetIds = await (0, hashes_1.getCacheablePedersenHash)((0, util_1.hexToBn)(constants_1.COLLATERAL_ASSET_ID_BY_NETWORK_ID[this.networkId]), constants_2.TRANSFER_FEE_ASSET_ID_BN);
        const transferPart1 = await (0, crypto_1.getPedersenHash)(await (0, crypto_1.getPedersenHash)(assetIds, receiverPublicKeyBn), conditionBn);
        // Note: Use toString() to avoid mutating senderPositionIdBn.
        const transferPart2 = new bn_js_1.default(senderPositionIdBn.toString(), 10)
            .iushln(constants_2.CONDITIONAL_TRANSFER_FIELD_BIT_LENGTHS.positionId).iadd(receiverPositionIdBn)
            .iushln(constants_2.CONDITIONAL_TRANSFER_FIELD_BIT_LENGTHS.positionId).iadd(senderPositionIdBn)
            .iushln(constants_2.CONDITIONAL_TRANSFER_FIELD_BIT_LENGTHS.nonce).iadd(nonceBn);
        const transferPart3 = new bn_js_1.default(CONDITIONAL_TRANSFER_PREFIX)
            .iushln(constants_2.CONDITIONAL_TRANSFER_FIELD_BIT_LENGTHS.quantumsAmount).iadd(quantumsAmountBn)
            .iushln(constants_2.CONDITIONAL_TRANSFER_FIELD_BIT_LENGTHS.quantumsAmount).iadd(MAX_AMOUNT_FEE_BN)
            .iushln(constants_2.CONDITIONAL_TRANSFER_FIELD_BIT_LENGTHS.expirationEpochHours).iadd(expirationEpochHoursBn)
            .iushln(CONDITIONAL_TRANSFER_PADDING_BITS);
        return (0, crypto_1.getPedersenHash)(await (0, crypto_1.getPedersenHash)(transferPart1, transferPart2), transferPart3);
    }
    toStarkware() {
        return this.message;
    }
}
exports.SignableConditionalTransfer = SignableConditionalTransfer;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29uZGl0aW9uYWwtdHJhbnNmZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvc2lnbmFibGUvY29uZGl0aW9uYWwtdHJhbnNmZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEsa0RBQXVCO0FBRXZCLDRDQUdzQjtBQUN0Qix3Q0FJb0I7QUFDcEIsMENBQWdEO0FBQ2hELHNDQUtxQjtBQU1yQiwyQ0FHcUI7QUFDckIscUNBQW9EO0FBQ3BELHFEQUFpRDtBQUVqRCwwREFBMEQ7QUFDMUQsTUFBTSxpQkFBaUIsR0FBRyxJQUFJLGVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUVwQyxNQUFNLDJCQUEyQixHQUFHLENBQUMsQ0FBQztBQUN0QyxNQUFNLGlDQUFpQyxHQUFHLEVBQUUsQ0FBQztBQUU3Qzs7R0FFRztBQUNILE1BQWEsMkJBQTRCLFNBQVEsOEJBQTJDO0lBRTFGLE1BQU0sQ0FBQyxZQUFZLENBQ2pCLFFBQW1DLEVBQ25DLFNBQW9CO1FBRXBCLE1BQU0sS0FBSyxHQUFHLElBQUEsMkJBQWlCLEVBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBRW5ELHFEQUFxRDtRQUNyRCxNQUFNLGNBQWMsR0FBRyxJQUFBLHlCQUFlLEVBQUMsUUFBUSxDQUFDLFdBQVcsRUFBRSw0QkFBZ0IsQ0FBQyxDQUFDO1FBRS9FLDBDQUEwQztRQUMxQyxNQUFNLG9CQUFvQixHQUFHLElBQUEsa0NBQXdCLEVBQUMsUUFBUSxDQUFDLHNCQUFzQixDQUFDLENBQUM7UUFFdkYsT0FBTyxJQUFJLDJCQUEyQixDQUNwQztZQUNFLGdCQUFnQixFQUFFLFFBQVEsQ0FBQyxnQkFBZ0I7WUFDM0Msa0JBQWtCLEVBQUUsUUFBUSxDQUFDLGtCQUFrQjtZQUMvQyxpQkFBaUIsRUFBRSxRQUFRLENBQUMsaUJBQWlCO1lBQzdDLFNBQVMsRUFBRSxJQUFBLHNCQUFlLEVBQUMsUUFBUSxDQUFDLG1CQUFtQixFQUFFLFFBQVEsQ0FBQyxJ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