"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.Exchange = void 0;
const big_js_1 = __importDefault(require("big.js"));
const bignumber_js_1 = __importDefault(require("bignumber.js"));
const lodash_1 = __importDefault(require("lodash"));
const zeroEx_1 = require("../clients/zeroEx");
const ierc20_abi_json_1 = __importDefault(require("../contracts/ierc20-abi.json"));
const Constants_1 = require("../lib/Constants");
const ContractCallHelpers_1 = require("../lib/ContractCallHelpers");
const helpers_1 = require("../lib/helpers");
const types_1 = require("../types");
class Exchange {
    constructor(contracts) {
        this.contracts = contracts;
    }
    getAddress() {
        return this.contracts.starkwarePerpetual.options.address;
    }
    getProxyDepositAddress() {
        return this.contracts.proxyDepositContract.options.address;
    }
    async register({ ethAddress, starkKey, signature, }, options) {
        return this.contracts.send(this.contracts.starkwarePerpetual, this.contracts.starkwarePerpetual.methods.registerUser(ethAddress, (0, ContractCallHelpers_1.starkKeyToUint256)(starkKey), signature), options);
    }
    async registerAndDeposit({ ethAddress, starkKey, signature, positionId, humanAmount, }, options) {
        return this.contracts.send(this.contracts.starkwarePerpetual, this.contracts.starkwarePerpetual.methods.registerAndDepositERC20(ethAddress, (0, ContractCallHelpers_1.starkKeyToUint256)(starkKey), signature, Constants_1.COLLATERAL_ASSET_ID[this.contracts.networkId], (0, ContractCallHelpers_1.bignumberableToUint256)(positionId), (0, ContractCallHelpers_1.humanCollateralAmountToUint256)(humanAmount)), options);
    }
    async deposit({ starkKey, positionId, humanAmount, }, options) {
        const depositFunctionSignature = 'deposit(uint256,uint256,uint256,uint256)';
        return this.contracts.send(this.contracts.starkwarePerpetual, this.contracts.starkwarePerpetual.methods[depositFunctionSignature]((0, ContractCallHelpers_1.starkKeyToUint256)(starkKey), Constants_1.COLLATERAL_ASSET_ID[this.contracts.networkId], (0, ContractCallHelpers_1.bignumberableToUint256)(positionId), (0, ContractCallHelpers_1.humanCollateralAmountToUint256)(humanAmount)), options);
    }
    async proxyDeposit({ humanAmount, starkKey, positionId, registerUserSignature = Buffer.from('', 'utf8'), }, options) {
        if (options === null || options === void 0 ? void 0 : options.sendGaslessTransaction) {
            return (0, helpers_1.sendGaslessTransaction)(this.contracts.proxyDepositContract.methods.deposit((0, ContractCallHelpers_1.humanCollateralAmountToUint256)(humanAmount), (0, ContractCallHelpers_1.starkKeyToUint256)(starkKey), (0, ContractCallHelpers_1.bignumberableToUint256)(positionId), registerUserSignature).send(options));
        }
        return this.contracts.send(this.contracts.proxyDepositContract, this.contracts.proxyDepositContract.methods.deposit((0, ContractCallHelpers_1.humanCollateralAmountToUint256)(humanAmount), (0, ContractCallHelpers_1.starkKeyToUint256)(starkKey), (0, ContractCallHelpers_1.bignumberableToUint256)(positionId), registerUserSignature), options);
    }
    async proxyDepositERC20({ humanMinUsdcAmount, starkKey, positionId, zeroExResponseObject, registerUserSignature = Buffer.from('', 'utf8'), getTokenApproval = false, getExchangeApproval = false, }, options) {
        const exchangeProxyData = this.encodeZeroExExchangeData({
            tokenFrom: getTokenApproval ? zeroExResponseObject.sellTokenAddress : Constants_1.ZERO_ADDRESS,
            allowanceTarget: getExchangeApproval ? zeroExResponseObject.allowanceTarget : Constants_1.ZERO_ADDRESS,
            minUsdcAmount: (0, ContractCallHelpers_1.humanCollateralAmountToUint256)(humanMinUsdcAmount),
            exchange: zeroExResponseObject.to,
            exchangeData: zeroExResponseObject.data.toString(),
        });
        if (options === null || options === void 0 ? void 0 : options.sendGaslessTransaction) {
            return (0, helpers_1.sendGaslessTransaction)(this.contracts.proxyDepositContract.methods.depositERC20(zeroExResponseObject.sellTokenAddress, zeroExResponseObject.sellAmount, (0, ContractCallHelpers_1.starkKeyToUint256)(starkKey), (0, ContractCallHelpers_1.bignumberableToUint256)(positionId), Constants_1.USDC_EXCHANGE_ADDRESSES[this.contracts.networkId], exchangeProxyData, registerUserSignature).send(options));
        }
        return this.contracts.send(this.contracts.proxyDepositContract, this.contracts.proxyDepositContract.methods.depositERC20(zeroExResponseObject.sellTokenAddress, zeroExResponseObject.sellAmount, (0, ContractCallHelpers_1.starkKeyToUint256)(starkKey), (0, ContractCallHelpers_1.bignumberableToUint256)(positionId), Constants_1.USDC_EXCHANGE_ADDRESSES[this.contracts.networkId], exchangeProxyData, registerUserSignature), options);
    }
    async proxyDepositEth({ humanMinUsdcAmount, starkKey, positionId, zeroExResponseObject, registerUserSignature = Buffer.from('', 'utf8'), }, options) {
        if ((options === null || options === void 0 ? void 0 : options.value) !== undefined && !(0, big_js_1.default)(options.value).eq(zeroExResponseObject.value)) {
            throw Error(`proxyDepositEth: A transaction value ${options.value} was provided which does not match the swap cost of ${zeroExResponseObject.value}`);
        }
        const exchangeProxyData = this.encodeZeroExExchangeData({
            tokenFrom: Constants_1.ZERO_ADDRESS,
            allowanceTarget: Constants_1.ZERO_ADDRESS,
            minUsdcAmount: (0, ContractCallHelpers_1.humanCollateralAmountToUint256)(humanMinUsdcAmount),
            exchange: zeroExResponseObject.to,
            exchangeData: zeroExResponseObject.data.toString(),
        });
        if (options === null || options === void 0 ? void 0 : options.sendGaslessTransaction) {
            return (0, helpers_1.sendGaslessTransaction)(this.contracts.proxyDepositContract.methods.depositEth((0, ContractCallHelpers_1.starkKeyToUint256)(starkKey), (0, ContractCallHelpers_1.bignumberableToUint256)(positionId), Constants_1.USDC_EXCHANGE_ADDRESSES[this.contracts.networkId], exchangeProxyData, registerUserSignature).send({ ...options, value: zeroExResponseObject.value }));
        }
        return this.contracts.send(this.contracts.proxyDepositContract, this.contracts.proxyDepositContract.methods.depositEth((0, ContractCallHelpers_1.starkKeyToUint256)(starkKey), (0, ContractCallHelpers_1.bignumberableToUint256)(positionId), Constants_1.USDC_EXCHANGE_ADDRESSES[this.contracts.networkId], exchangeProxyData, registerUserSignature), { ...options, value: zeroExResponseObject.value });
    }
    /**
     * @description get expected and worst USDC for some amount of input sellToken.
     * @notice For eth pass in 'ETH' as the sellToken.
     */
    async estimateConversionAmount({ humanSellAmount, sellToken, decimals, slippagePercentage, }) {
        (0, zeroEx_1.validateSlippage)(slippagePercentage);
        const sellAmount = (0, ContractCallHelpers_1.humanTokenAmountToUint256)(humanSellAmount, decimals);
        const zeroExResponseObject = await (0, zeroEx_1.getZeroExSwapQuote)({
            sellAmount,
            sellToken,
            buyTokenAddress: (0, helpers_1.getUsdcAddress)(this.contracts.networkId),
            slippagePercentage,
            networkId: this.contracts.networkId,
        });
        const expectedUsdcHumanAmount = (0, big_js_1.default)(zeroExResponseObject.buyAmount);
        expectedUsdcHumanAmount.e -= types_1.BASE_DECIMALS;
        const worstUsdcHumanAmount = (0, big_js_1.default)(humanSellAmount).mul(zeroExResponseObject.guaranteedPrice);
        return {
            expectedUsdcHumanAmount: expectedUsdcHumanAmount.round(types_1.BASE_DECIMALS, 0).toString(),
            worstUsdcHumanAmount: worstUsdcHumanAmount.round(types_1.BASE_DECIMALS, 0).toString(),
            zeroExResponseObject,
        };
    }
    async withdraw({ starkKey, }, options) {
        return this.contracts.send(this.contracts.starkwarePerpetual, this.contracts.starkwarePerpetual.methods.withdraw((0, ContractCallHelpers_1.starkKeyToUint256)(starkKey), Constants_1.COLLATERAL_ASSET_ID[this.contracts.networkId]), options);
    }
    async withdrawTo({ starkKey, recipient, }, options) {
        return this.contracts.send(this.contracts.starkwarePerpetual, this.contracts.starkwarePerpetual.methods.withdrawTo((0, ContractCallHelpers_1.starkKeyToUint256)(starkKey), Constants_1.COLLATERAL_ASSET_ID[this.contracts.networkId], recipient), options);
    }
    async forcedWithdrawalRequest({ starkKey, positionId, humanAmount, premiumCost, }, options) {
        return this.contracts.send(this.contracts.starkwarePerpetual, this.contracts.starkwarePerpetual.methods.forcedWithdrawalRequest((0, ContractCallHelpers_1.starkKeyToUint256)(starkKey), (0, ContractCallHelpers_1.bignumberableToUint256)(positionId), (0, ContractCallHelpers_1.humanCollateralAmountToUint256)(humanAmount), premiumCost), options);
    }
    async setERC20Allowance({ tokenAddress, address, amount, }, options) {
        const token = new this.contracts.web3.eth.Contract(ierc20_abi_json_1.default.abi);
        token.options.address = tokenAddress;
        return this.contracts.send(token, token.methods.approve(address, amount), options);
    }
    // ============ Getters ============
    async getEthKey({ starkKey, }, options) {
        try {
            const result = await this.contracts.call(this.contracts.starkwarePerpetual.methods.getEthKey((0, ContractCallHelpers_1.starkKeyToUint256)(starkKey)), options);
            return result;
        }
        catch (e) {
            if (e.message && e.message.includes('USER_UNREGISTERED')) {
                return null;
            }
            throw e;
        }
    }
    async getWithdrawalBalance({ starkKey, }, options) {
        const result = await this.contracts.call(this.contracts.starkwarePerpetual.methods.getWithdrawalBalance((0, ContractCallHelpers_1.starkKeyToUint256)(starkKey), Constants_1.COLLATERAL_ASSET_ID[this.contracts.networkId]), options);
        return (0, ContractCallHelpers_1.uint256ToHumanCollateralTokenAmount)(result);
    }
    async hasCancellationRequest({ starkKey, vaultId, }, options) {
        const result = await this.contracts.call(this.contracts.starkwarePerpetual.methods.getCancellationRequest((0, ContractCallHelpers_1.starkKeyToUint256)(starkKey), Constants_1.COLLATERAL_ASSET_ID[this.contracts.networkId], (0, ContractCallHelpers_1.bignumberableToUint256)(vaultId)), options);
        return !new bignumber_js_1.default(result).isZero();
    }
    async hasForcedWithdrawalRequest({ starkKey, positionId, humanAmount, }, options) {
        const result = await this.contracts.call(this.contracts.starkwarePerpetual.methods.getForcedWithdrawalRequest((0, ContractCallHelpers_1.starkKeyToUint256)(starkKey), (0, ContractCallHelpers_1.bignumberableToUint256)(positionId), (0, ContractCallHelpers_1.humanCollateralAmountToUint256)(humanAmount)), options);
        return !new bignumber_js_1.default(result).isZero();
    }
    async getERC20Allowance({ ownerAddress, spenderAddress, tokenAddress, decimals, }, options) {
        const token = new this.contracts.web3.eth.Contract(ierc20_abi_json_1.default.abi);
        token.options.address = tokenAddress;
        const allowance = await this.contracts.call(token.methods.allowance(ownerAddress, spenderAddress), options);
        return (0, ContractCallHelpers_1.uint256ToHumanTokenAmount)(allowance, decimals);
    }
    encodeZeroExExchangeData(proxyExchangeData) {
        return this.contracts.web3.eth.abi.encodeParameters([
            'address',
            'address',
            'uint256',
            'address',
            'bytes',
        ], lodash_1.default.at(proxyExchangeData, [
            'tokenFrom',
            'allowanceTarget',
            'minUsdcAmount',
            'exchange',
            'exchangeData',
        ]));
    }
}
exports.Exchange = Exchange;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRXhjaGFuZ2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvbW9kdWxlcy9FeGNoYW5nZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7QUFBQSxvREFBeUI7QUFDekIsZ0VBQXFDO0FBQ3JDLG9EQUF1QjtBQUV2Qiw4Q0FHMkI7QUFDM0IsbUZBQW9EO0FBQ3BELGdEQUkwQjtBQUMxQixvRUFPb0M7QUFLcEMsNENBR3dCO0FBQ3hCLG9DQVFrQjtBQUVsQixNQUFhLFFBQVE7SUFHbkIsWUFDRSxTQUFvQjtRQUVwQixJQUFJLENBQUMsU0FBUyxHQUFHLFNBQVMsQ0FBQztJQUM3QixDQUFDO0lBRU0sVUFBVTtRQUNmLE9BQU8sSUFBSSxDQUFDLFNBQVMsQ0FBQyxrQkFBa0IsQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDO0lBQzNELENBQUM7SUFFTSxzQkFBc0I7UUFDM0IsT0FBTyxJQUFJLENBQUMsU0FBUyxDQUFDLG9CQUFvQixDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUM7SUFDN0QsQ0FBQztJQUVNLEtBQUssQ0FBQyxRQUFRLENBQ25CLEVBQ0UsVUFBVSxFQUNWLFFBQVEsRUFDUixTQUFTLEdBS1YsRUFDRCxPQUFxQjtRQUVyQixPQUFPLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUN4QixJQUFJLENBQUMsU0FBUyxDQUFDLGtCQUFrQixFQUNqQyxJQUFJLENBQUMsU0FBUyxDQUFDLGtCQUFrQixDQUFDLE9BQU8sQ0FBQyxZQUFZLENBQ3BELFVBQVUsRUFDVixJQUFBLHVDQUFpQixFQUFDLFFBQVEsQ0FBQyxFQUMzQixTQUFTLENBQ1YsRUFDRCxPQUFPLENBQ1IsQ0FBQztJQUNKLENBQUM7SUFFTSxLQUFLLENBQUMsa0JBQWtCLENBQzdCLEVBQ0UsVUFBVSxFQUNWLFFBQVEsRUFDUixTQUFTLEVBQ1QsVUFBVSxFQUNWLFdBQVcsR0FPWixFQUNELE9BQXFCO1FBRXJCLE9BQU8sSUFBSSxDQUFDLFNBQVMsQ0FBQyxJ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